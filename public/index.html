<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Babyphone_2</title>
<style>
  body {
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    background: #f4f4f4;
  }
  h1 {
    margin-bottom: 20px;
  }
  button {
    font-size: 1.5em;
    padding: 15px 30px;
    margin: 10px;
    width: 90%;
    max-width: 400px;
    border: none;
    border-radius: 10px;
    background-color: #4CAF50;
    color: white;
  }
  button:hover {
    background-color: #45a049;
  }
  video {
    margin-top: 20px;
    width: 90%;
    max-width: 400px;
    border: 2px solid #333;
    border-radius: 10px;
  }
  #cameraSelect {
    margin-top: 10px;
    font-size: 1em;
    padding: 5px;
    width: 90%;
    max-width: 400px;
  }
</style>
</head>
<body>

<h1>Babyphone_2</h1>
<button onclick="start('sender')">?? Sender</button>
<button onclick="start('receiver')">?? Empfänger</button>

<select id="cameraSelect" style="display: none;"></select>

<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<script>
const ws = new WebSocket(location.origin.replace(/^http/, 'ws'));
let pc;

ws.onopen = () => console.log("[DEBUG] WebSocket verbunden");
ws.onerror = e => console.error("[DEBUG] WebSocket Fehler:", e);
ws.onclose = () => console.log("[DEBUG] WebSocket Verbindung geschlossen");

async function start(role) {
  console.log(`[DEBUG] Starte als ${role}`);

  pc = new RTCPeerConnection();

  pc.onicecandidate = e => {
    if (e.candidate) {
      ws.send(JSON.stringify({ candidate: e.candidate }));
    }
  };

  pc.ontrack = e => {
    document.getElementById('remoteVideo').srcObject = e.streams[0];
  };

  ws.onmessage = async msg => {
    let text = msg.data instanceof Blob ? await msg.data.text() : msg.data;
    let data;
    try { data = JSON.parse(text); } catch { return; }

    if (data.sdp) {
      await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
      if (data.sdp.type === 'offer') {
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ sdp: pc.localDescription }));
      }
    } else if (data.candidate) {
      await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
    }
  };


if (role === 'sender') {
    const select = document.getElementById('cameraSelect');
    select.style.display = 'block';
    await fillCameraSelect();

    if (select.options.length === 1) {
        console.log("[DEBUG] Nur eine Kamera gefunden, starte direkt");
        await startLocalStreamAndOffer();
    } else {
        console.log("[DEBUG] Mehrere Kameras gefunden, warte auf Auswahl");
        select.onchange = async () => {
            console.log("[DEBUG] Kamera gewählt:", select.value);
            await startLocalStreamAndOffer();
        };
    }
}


async function fillCameraSelect() {
  const select = document.getElementById('cameraSelect');
  select.innerHTML = ''; // leeren
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoDevices = devices.filter(d => d.kind === 'videoinput');
  videoDevices.forEach(device => {
    const option = document.createElement('option');
    option.value = device.deviceId;
    option.text = device.label || `Kamera ${select.length+1}`;
    select.appendChild(option);
  });
}

async function startLocalStreamAndOffer() {
  try {
    const select = document.getElementById('cameraSelect');
    const cameraId = select.value;

    let constraints;
    if (select.options.length === 1) {
      console.log("[DEBUG] Nur eine Kamera – starte ohne deviceId");
      constraints = { video: true };
    } else {
      console.log("[DEBUG] Mehrere Kameras – benutze deviceId:", cameraId);
      constraints = { video: { deviceId: { exact: cameraId } } };
    }

    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    document.getElementById('localVideo').srcObject = stream;
    stream.getTracks().forEach(track => pc.addTrack(track, stream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({ sdp: pc.localDescription }));
  } catch (err) {
    console.error("[DEBUG] Fehler beim Zugriff auf Kamera oder Erstellen des Offers:", err);
  }
}

}
</script>
</body>
</html>
